# Deployment (QS-JWT Docs)

Developer-focused instructions for building and deploying the QS-JWT documentation site.

## Scripts (package.json)

| Script       | Purpose                                                                               |
| ------------ | ------------------------------------------------------------------------------------- |
| pre:version  | Fetch latest released qs-jwt tag via GitHub API → writes `docs/.vitepress/version.js` |
| docs:dev     | Generate version file, start VitePress dev server                                     |
| docs:build   | Generate version file, build static site into `docs/.vitepress/dist`                  |
| docs:preview | Build then preview locally                                                            |
| deploy       | Build then publish dist folder to `gh-pages` branch using `gh-pages` package          |
| deploy:ci    | Build only (used by GitHub Pages workflow artifact upload)                            |

`pre:version` is tolerant to API failures: falls back to existing file or `v0.0.0`. Provide `GITHUB_TOKEN` (or `GH_TOKEN`) locally to avoid rate limits. GitHub Actions job token is used automatically in CI.

Generated file example:

```js
// Auto-generated by scripts/fetch-qs-jwt-version.mjs – do not edit
export const version = "v1.2.3";
```

## Automated Deployment (GitHub Pages)

- Workflow: `.github/workflows/deploy.yml`.
- Trigger: push to `main` or manual dispatch.
- Pipeline: checkout → setup node → install (`npm ci`) → `npm run docs:build` (runs version fetch) → upload artifact → `actions/deploy-pages`.
- Result: Site published to Pages (custom domain if CNAME present).

One-time setup: Settings → Pages → Source = GitHub Actions. Add custom domain if desired.

## Manual Deployment (Local)

One-time:

1. `npm install`
2. (Optional) `export GITHUB_TOKEN=...`

Deploy:

```bash
npm run deploy
```

Pushes built `docs/.vitepress/dist` to `gh-pages` branch.

Build only:

```bash
npm run docs:build
```

Preview build output:

```bash
npm run docs:preview
```

## Local Development

```bash
npm run docs:dev
```

Hot reload, version file generated at start.

## Custom Domain

If using a custom domain, ensure `docs/public/CNAME` contains the domain (example already: `qs-jwt.ptarmiganlabs.com`). DNS: CNAME that domain → `ptarmiganlabs.github.io`. Enable HTTPS in Pages settings after certificate issuance.

## Environment Variables

| Variable                                    | Purpose                                                                |
| ------------------------------------------- | ---------------------------------------------------------------------- |
| GITHUB_TOKEN / GH_TOKEN / GITHUB_AUTH_TOKEN | Authenticated GitHub API calls for version fetch (avoid rate limiting) |

## Troubleshooting (Quick)

| Issue                  | Action                                                                 |
| ---------------------- | ---------------------------------------------------------------------- |
| Version shows v0.0.0   | Provide token; re-run build                                            |
| Build fails            | `npm ci && npm run docs:build`; check image paths under `docs/public/` |
| Pages not updating     | Inspect workflow logs; verify Pages source is GitHub Actions           |
| 404 after first deploy | Wait a minute for Pages provisioning                                   |
| Wrong asset paths      | Adjust `base` in VitePress config if hosted under a sub-path           |

## Maintenance

1. Keep vitepress + gh-pages updated (Renovate handles automatically if enabled).
2. Monitor upstream tag naming conventions; adjust normalization logic if needed.
3. Review workflow permissions if repository security settings change.
